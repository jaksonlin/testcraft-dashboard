# Development Docker Compose Configuration
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # PostgreSQL Primary Database (Dev Override)
  postgres:
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: test_analytics_dev
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./init-db-dev.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d test_analytics_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - testcraft-network

  # Backend (Dev Override) - Hot reload with Spring DevTools
  backend:
    build:
      context: ..
      dockerfile: ./deployment/Dockerfile.backend.hotreload
      target: hotreload-dev
    environment:
      SPRING_PROFILES_ACTIVE: dev
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: test_analytics_dev
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      SPRING_DEVTOOLS_RESTART_ENABLED: "true"
      SPRING_DEVTOOLS_RESTART_POLL_INTERVAL: "1000"
      SPRING_DEVTOOLS_RESTART_QUIET_PERIOD: "500"
      JAVA_TOOL_OPTIONS: "-Xms128m -Xmx512m -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
    ports:
      - "8090:8090"
      - "5005:5005"  # Debug port for IDE attachment
    volumes:
      - ../pom.xml:/app/pom.xml:ro
      - ../src:/app/src:ro
      - ../target:/app/target
      - ../reports:/app/reports
      - maven_cache:/root/.m2
    depends_on:
      - postgres
    networks:
      - testcraft-network
    # Health check to ensure backend is ready
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/api/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # Frontend (Dev Override) - Use Vite dev server for hot reload
  frontend:
    build:
      context: ..
      dockerfile: ./deployment/Dockerfile.frontend
      target: development
    environment:
      VITE_API_URL: http://localhost/api
      CHOKIDAR_USEPOLLING: "true"
    ports:
      - "5173:5173"  # Vite dev server
    volumes:
      - ../frontend/src:/app/src
      - ../frontend/public:/app/public
      - ../frontend/index.html:/app/index.html
      - ../frontend/vite.config.ts:/app/vite.config.ts
      - ../frontend/tsconfig.json:/app/tsconfig.json
      - ../frontend/package.json:/app/package.json
      - frontend_node_modules:/app/node_modules
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
    networks:
      - testcraft-network

  # Nginx (Dev Override) - Different configuration for dev
  nginx:
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d.dev:/etc/nginx/conf.d:ro
    ports:
      - "80:80"
    networks:
      - testcraft-network

  # pgAdmin for database management (Dev only)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: testcraft-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@testcraft.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
      PGADMIN_CONFIG_WTF_CSRF_ENABLED: 'True'
      PGADMIN_CONFIG_WTF_CSRF_TIME_LIMIT: 'None'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - testcraft-network

volumes:
  postgres_dev_data:
    name: testcraft_postgres_dev_data
  maven_cache:
    name: testcraft_maven_cache
  frontend_node_modules:
    name: testcraft_frontend_node_modules
  pgadmin_data:
    name: testcraft_pgadmin_data

networks:
  testcraft-network:
    driver: bridge
    name: testcraft-network
